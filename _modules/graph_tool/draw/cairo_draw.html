<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>graph_tool.draw.cairo_draw &mdash; graph-tool 2.2.44 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/gt_style.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.2.44',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/MathJax/MathJax.js?config=default"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within graph-tool 2.2.44 documentation"
          href="../../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../../_static/graph-icon.ico"/>
    <link rel="top" title="graph-tool 2.2.44 documentation" href="../../../index.html" />
    <link rel="up" title="graph_tool.draw" href="../draw.html" />
    <script type="text/javascript">
      var _gaq = _gaq || [];
      var pluginUrl =
        '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
      _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
      _gaq.push(['_setAccount', 'UA-248813-2']);
      _gaq.push(['_setDomainName', '.skewed.de']);
      _gaq.push(['_trackPageview']);
      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
     

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><img src="../../../_static/graph-icon.png" alt="logo" style="margin-right: 5px; margin-bottom:-2px;" /><a href="/">Project Homepage</a> &raquo;</li>
    
        <li class="nav-item nav-item-0"><a href="../../../index.html">graph-tool 2.2.44 documentation</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../graph_tool.html" >graph_tool</a> &raquo;</li>
          <li class="nav-item nav-item-3"><a href="../draw.html" accesskey="U">graph_tool.draw</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for graph_tool.draw.cairo_draw</h1><div class="highlight"><pre>
<span class="c">#! /usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c"># graph_tool -- a general graph manipulation python module</span>
<span class="c">#</span>
<span class="c"># Copyright (C) 2006-2015 Tiago de Paula Peixoto &lt;tiago@skewed.de&gt;</span>
<span class="c">#</span>
<span class="c"># This program is free software: you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU General Public License as published by</span>
<span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c"># (at your option) any later version.</span>
<span class="c">#</span>
<span class="c"># This program is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c"># GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU General Public License</span>
<span class="c"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
    <span class="nb">range</span> <span class="o">=</span> <span class="nb">xrange</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cairo</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Error importing cairo. Graph drawing will not work.&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="k">raise</span>

<span class="n">default_cm</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib.artist</span>
    <span class="kn">import</span> <span class="nn">matplotlib.backends.backend_cairo</span>
    <span class="kn">import</span> <span class="nn">matplotlib.cm</span>
    <span class="kn">import</span> <span class="nn">matplotlib.colors</span>
    <span class="kn">from</span> <span class="nn">matplotlib.cbook</span> <span class="kn">import</span> <span class="n">flatten</span>
    <span class="n">default_clrs</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.5529411764705883</span><span class="p">,</span> <span class="mf">0.8274509803921568</span><span class="p">,</span> <span class="mf">0.7803921568627451</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="c">#(1.0, 1.0, 0.7019607843137254, 1.0),</span>
                    <span class="p">(</span><span class="mf">0.7450980392156863</span><span class="p">,</span> <span class="mf">0.7294117647058823</span><span class="p">,</span> <span class="mf">0.8549019607843137</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.984313725490196</span><span class="p">,</span> <span class="mf">0.5019607843137255</span><span class="p">,</span> <span class="mf">0.4470588235294118</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.5019607843137255</span><span class="p">,</span> <span class="mf">0.6941176470588235</span><span class="p">,</span> <span class="mf">0.8274509803921568</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.9921568627450981</span><span class="p">,</span> <span class="mf">0.7058823529411765</span><span class="p">,</span> <span class="mf">0.3843137254901961</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.7019607843137254</span><span class="p">,</span> <span class="mf">0.8705882352941177</span><span class="p">,</span> <span class="mf">0.4117647058823529</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.9882352941176471</span><span class="p">,</span> <span class="mf">0.803921568627451</span><span class="p">,</span> <span class="mf">0.8980392156862745</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.8509803921568627</span><span class="p">,</span> <span class="mf">0.8509803921568627</span><span class="p">,</span> <span class="mf">0.8509803921568627</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.7372549019607844</span><span class="p">,</span> <span class="mf">0.5019607843137255</span><span class="p">,</span> <span class="mf">0.7411764705882353</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9215686274509803</span><span class="p">,</span> <span class="mf">0.7725490196078432</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9294117647058824</span><span class="p">,</span> <span class="mf">0.43529411764705883</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span>
    <span class="n">default_cm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s">&quot;Set3&quot;</span><span class="p">,</span>
                                                                     <span class="n">default_clrs</span><span class="p">)</span>
    <span class="n">is_draw_inline</span> <span class="o">=</span> <span class="s">&#39;inline&#39;</span> <span class="ow">in</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Error importing matplotlib module. Graph drawing will not work.&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="k">raise</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">IPython.display</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">GraphView</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">,</span> <span class="n">ungroup_vector_property</span><span class="p">,</span>\
     <span class="n">group_vector_property</span><span class="p">,</span> <span class="n">_prop</span><span class="p">,</span> <span class="n">_check_prop_vector</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="nn">stats</span> <span class="kn">import</span> <span class="n">label_parallel_edges</span><span class="p">,</span> <span class="n">label_self_loops</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="nn">dl_import</span> <span class="kn">import</span> <span class="n">dl_import</span>
<span class="n">dl_import</span><span class="p">(</span><span class="s">&quot;from . import libgraph_tool_draw&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.libgraph_tool_draw</span> <span class="kn">import</span> <span class="n">vertex_attrs</span><span class="p">,</span> <span class="n">edge_attrs</span><span class="p">,</span> <span class="n">vertex_shape</span><span class="p">,</span>\
        <span class="n">edge_marker</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Error importing cairo-based drawing library. &quot;</span> <span class="o">+</span> \
        <span class="s">&quot;Was graph-tool compiled with cairomm support?&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="nn">draw</span> <span class="kn">import</span> <span class="n">sfdp_layout</span><span class="p">,</span> <span class="n">random_layout</span><span class="p">,</span> <span class="n">_avg_edge_distance</span><span class="p">,</span> \
    <span class="n">coarse_graphs</span><span class="p">,</span> <span class="n">radial_tree_layout</span><span class="p">,</span> <span class="n">prop_to_size</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">colorConverter</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="nn">generation</span> <span class="kn">import</span> <span class="n">graph_union</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="nn">topology</span> <span class="kn">import</span> <span class="n">shortest_path</span>

<span class="n">_vdefaults</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;shape&quot;</span><span class="p">:</span> <span class="s">&quot;circle&quot;</span><span class="p">,</span>
    <span class="s">&quot;color&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
    <span class="s">&quot;fill_color&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6470588235294118</span><span class="p">,</span> <span class="mf">0.058823529411764705</span><span class="p">,</span> <span class="mf">0.08235294117647059</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
    <span class="s">&quot;size&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s">&quot;aspect&quot;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
    <span class="s">&quot;anchor&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&quot;pen_width&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s">&quot;halo&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s">&quot;halo_color&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
    <span class="s">&quot;halo_size&quot;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
    <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
    <span class="s">&quot;text_color&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>
    <span class="s">&quot;text_position&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>
    <span class="s">&quot;text_rotation&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
    <span class="s">&quot;text_offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
    <span class="s">&quot;font_family&quot;</span><span class="p">:</span> <span class="s">&quot;serif&quot;</span><span class="p">,</span>
    <span class="s">&quot;font_slant&quot;</span><span class="p">:</span> <span class="n">cairo</span><span class="o">.</span><span class="n">FONT_SLANT_NORMAL</span><span class="p">,</span>
    <span class="s">&quot;font_weight&quot;</span><span class="p">:</span> <span class="n">cairo</span><span class="o">.</span><span class="n">FONT_WEIGHT_NORMAL</span><span class="p">,</span>
    <span class="s">&quot;font_size&quot;</span><span class="p">:</span> <span class="mf">12.</span><span class="p">,</span>
    <span class="s">&quot;surface&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&quot;pie_fractions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span>
    <span class="s">&quot;pie_colors&quot;</span><span class="p">:</span> <span class="n">default_clrs</span> <span class="c"># (&#39;b&#39;, &#39;g&#39;, &#39;r&#39;, &#39;c&#39;, &#39;m&#39;, &#39;y&#39;, &#39;k&#39;)</span>
    <span class="p">}</span>

<span class="n">_edefaults</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;color&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.1796875</span><span class="p">,</span> <span class="mf">0.203125</span><span class="p">,</span> <span class="mf">0.2109375</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
    <span class="s">&quot;pen_width&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&quot;start_marker&quot;</span><span class="p">:</span> <span class="s">&quot;none&quot;</span><span class="p">,</span>
    <span class="s">&quot;mid_marker&quot;</span><span class="p">:</span> <span class="s">&quot;none&quot;</span><span class="p">,</span>
    <span class="s">&quot;end_marker&quot;</span><span class="p">:</span> <span class="s">&quot;none&quot;</span><span class="p">,</span>
    <span class="s">&quot;marker_size&quot;</span><span class="p">:</span> <span class="mf">4.</span><span class="p">,</span>
    <span class="s">&quot;mid_marker_pos&quot;</span><span class="p">:</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span>
    <span class="s">&quot;control_points&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s">&quot;gradient&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s">&quot;dash_style&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
    <span class="s">&quot;text_color&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
    <span class="s">&quot;text_distance&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s">&quot;text_parallel&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="s">&quot;font_family&quot;</span><span class="p">:</span> <span class="s">&quot;serif&quot;</span><span class="p">,</span>
    <span class="s">&quot;font_slant&quot;</span><span class="p">:</span> <span class="n">cairo</span><span class="o">.</span><span class="n">FONT_SLANT_NORMAL</span><span class="p">,</span>
    <span class="s">&quot;font_weight&quot;</span><span class="p">:</span> <span class="n">cairo</span><span class="o">.</span><span class="n">FONT_WEIGHT_NORMAL</span><span class="p">,</span>
    <span class="s">&quot;font_size&quot;</span><span class="p">:</span> <span class="mf">12.</span><span class="p">,</span>
    <span class="s">&quot;sloppy&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s">&quot;seamless&quot;</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">shape_from_prop</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">enum</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">shape</span><span class="o">.</span><span class="n">key_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;v&quot;</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;int&quot;</span><span class="p">)</span>
            <span class="n">descs</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">descs</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">edges</span><span class="p">()</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;int&quot;</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">offset</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">enum</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">descs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shape</span><span class="o">.</span><span class="n">value_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span><span class="p">:</span>
                <span class="n">prop</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">shape</span><span class="p">[</span><span class="n">v</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="n">prop</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">v</span><span class="p">])])</span>
            <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">-</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="n">prop</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">-</span> <span class="n">offset</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid value for attribute </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">enum</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">v</span><span class="p">])))</span>
        <span class="k">return</span> <span class="n">prop</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">shape</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">shape</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid value for attribute </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">enum</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">shape</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">open_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;r&quot;</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&quot;.gz&quot;</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">base</span>
    <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&quot;.bz2&quot;</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">base</span>
    <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&quot;.zip&quot;</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">base</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">fmt</span>

<span class="k">def</span> <span class="nf">get_file_fmt</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&quot;.gz&quot;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">base</span>
    <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&quot;.bz2&quot;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">base</span>
    <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&quot;.zip&quot;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">base</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fmt</span>


<span class="k">def</span> <span class="nf">surface_from_prop</span><span class="p">(</span><span class="n">surface</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">surface</span><span class="o">.</span><span class="n">key_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;v&quot;</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;object&quot;</span><span class="p">)</span>
            <span class="n">descs</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">descs</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">edges</span><span class="p">()</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;object&quot;</span><span class="p">)</span>
        <span class="n">surface_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">descs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">surface</span><span class="o">.</span><span class="n">value_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">surface</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">surface_map</span><span class="p">:</span>
                    <span class="n">sfc</span> <span class="o">=</span> <span class="n">gen_surface</span><span class="p">(</span><span class="n">surface</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                    <span class="n">surface_map</span><span class="p">[</span><span class="n">surface</span><span class="p">[</span><span class="n">v</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sfc</span>
                <span class="n">prop</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">surface_map</span><span class="p">[</span><span class="n">surface</span><span class="p">[</span><span class="n">v</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">surface</span><span class="o">.</span><span class="n">value_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;python::object&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surface</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">cairo</span><span class="o">.</span><span class="n">Surface</span><span class="p">):</span>
                    <span class="n">prop</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">surface</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid value type for surface property: &quot;</span> <span class="o">+</span>
                                     <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">surface</span><span class="p">[</span><span class="n">v</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid value type for surface property: &quot;</span> <span class="o">+</span>
                                 <span class="n">surface</span><span class="o">.</span><span class="n">value_type</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">prop</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gen_surface</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">cairo</span><span class="o">.</span><span class="n">Surface</span><span class="p">)</span> <span class="ow">or</span> <span class="n">surface</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">surface</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid value for attribute surface: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">surface</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">centered_rotation</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">text_pos</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ungroup_vector_property</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">fa</span> <span class="o">-</span> <span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">fa</span> <span class="o">-</span> <span class="n">cm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">)</span>
    <span class="n">angle</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">angle</span><span class="o">.</span><span class="n">fa</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span>
    <span class="n">angle</span><span class="o">.</span><span class="n">fa</span> <span class="o">%=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span>
    <span class="k">if</span> <span class="n">text_pos</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">tpos</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">)</span>
        <span class="n">angle</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pi</span>
        <span class="n">tpos</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span>
        <span class="k">return</span> <span class="n">angle</span><span class="p">,</span> <span class="n">tpos</span>
    <span class="k">return</span> <span class="n">angle</span>

<span class="k">def</span> <span class="nf">_convert</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">cmap</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="n">vertex_attrs</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">shape_from_prop</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">vertex_shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="n">vertex_attrs</span><span class="o">.</span><span class="n">surface</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">surface_from_prop</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">edge_attrs</span><span class="o">.</span><span class="n">start_marker</span><span class="p">,</span> <span class="n">edge_attrs</span><span class="o">.</span><span class="n">mid_marker</span><span class="p">,</span>
                <span class="n">edge_attrs</span><span class="o">.</span><span class="n">end_marker</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">shape_from_prop</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">edge_marker</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">vertex_attrs</span><span class="o">.</span><span class="n">pie_colors</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">value_type</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;vector&lt;long double&gt;&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">val</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">value_type</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;vector&lt;int32_t&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;vector&lt;int64_t&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;vector&lt;bool&gt;&quot;</span><span class="p">]:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span>
                <span class="n">new_val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
                <span class="n">rg</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s">&quot;inf&quot;</span><span class="p">),</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s">&quot;inf&quot;</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">[</span><span class="n">v</span><span class="p">]:</span>
                        <span class="n">rg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">rg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">rg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">rg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">rg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
                    <span class="n">new_val</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">([</span><span class="n">cmap</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">rg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">rg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">[</span><span class="n">v</span><span class="p">]])</span>
                <span class="k">return</span> <span class="n">new_val</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">value_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;vector&lt;string&gt;&quot;</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span>
                <span class="n">new_val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
                    <span class="n">new_val</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">([</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ColorConverter</span><span class="p">()</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">[</span><span class="n">v</span><span class="p">]])</span>
                <span class="k">return</span> <span class="n">new_val</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">value_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;python::object&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span>
                    <span class="n">new_val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">new_val</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">v</span><span class="p">])]</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">new_val</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">([</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ColorConverter</span><span class="p">()</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">[</span><span class="n">v</span><span class="p">]])</span>
                    <span class="k">return</span> <span class="n">new_val</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_val</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ColorConverter</span><span class="p">()</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
    <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">vertex_attrs</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> <span class="n">vertex_attrs</span><span class="o">.</span><span class="n">fill_color</span><span class="p">,</span>
                <span class="n">vertex_attrs</span><span class="o">.</span><span class="n">text_color</span><span class="p">,</span> <span class="n">vertex_attrs</span><span class="o">.</span><span class="n">halo_color</span><span class="p">,</span>
                <span class="n">edge_attrs</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> <span class="n">edge_attrs</span><span class="o">.</span><span class="n">text_color</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ColorConverter</span><span class="p">()</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">value_type</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;vector&lt;long double&gt;&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">val</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">value_type</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;int32_t&quot;</span><span class="p">,</span> <span class="s">&quot;int64_t&quot;</span><span class="p">,</span> <span class="s">&quot;double&quot;</span><span class="p">,</span>
                                    <span class="s">&quot;long double&quot;</span><span class="p">,</span> <span class="s">&quot;unsigned long&quot;</span><span class="p">,</span> <span class="s">&quot;bool&quot;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">val</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">vrange</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
                    <span class="n">vrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">vrange</span><span class="p">,</span> <span class="n">vrange</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
                        <span class="n">vrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">vrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                        <span class="n">vrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vrange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                <span class="n">cnorm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">vmax</span><span class="o">=</span><span class="n">vrange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">key_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;v&quot;</span><span class="p">:</span>
                    <span class="n">prop</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
                    <span class="n">descs</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prop</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
                    <span class="n">descs</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">edges</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">descs</span><span class="p">:</span>
                    <span class="n">prop</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">cnorm</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">v</span><span class="p">]))</span>
                <span class="k">return</span> <span class="n">prop</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">value_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">key_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;v&quot;</span><span class="p">:</span>
                    <span class="n">prop</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
                        <span class="n">prop</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ColorConverter</span><span class="p">()</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">val</span><span class="o">.</span><span class="n">key_type</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;e&quot;</span><span class="p">:</span>
                    <span class="n">prop</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                        <span class="n">prop</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ColorConverter</span><span class="p">()</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">prop</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid value for attribute </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">cmap</span><span class="p">):</span>
    <span class="n">nattrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s">&quot;v&quot;</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">vertex_attrs</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="n">edge_attrs</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Unknown attribute: &quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="n">nattrs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_prop</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">_convert</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">cmap</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">defaults</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">attr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_convert</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nattrs</span><span class="p">,</span> <span class="n">defaults</span>


<span class="k">def</span> <span class="nf">get_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">defaults</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">p</span>


<span class="k">def</span> <span class="nf">position_parallel_edges</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">loop_angle</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s">&quot;nan&quot;</span><span class="p">),</span>
                            <span class="n">parallel_distance</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">label_parallel_edges</span><span class="p">(</span><span class="n">GraphView</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">directed</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">label_self_loops</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loop_angle</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">loop_angle</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">)</span>
        <span class="n">angle</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loop_angle</span><span class="p">)</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">GraphView</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">directed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lp</span><span class="o">.</span><span class="n">fa</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">lp</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span>
        <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="o">.</span><span class="n">fa</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ll</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spline</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
        <span class="n">libgraph_tool_draw</span><span class="o">.</span><span class="n">put_parallel_splines</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">_Graph__graph</span><span class="p">,</span>
                                                <span class="n">_prop</span><span class="p">(</span><span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span>
                                                <span class="n">_prop</span><span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">lp</span><span class="p">),</span>
                                                <span class="n">_prop</span><span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">spline</span><span class="p">),</span>
                                                <span class="n">_prop</span><span class="p">(</span><span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">angle</span><span class="p">),</span>
                                                <span class="n">parallel_distance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spline</span>


<span class="k">def</span> <span class="nf">parse_props</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">props</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">others</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span><span class="p">):</span>
            <span class="n">props</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">others</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">props</span><span class="p">,</span> <span class="n">others</span>


<div class="viewcode-block" id="cairo_draw"><a class="viewcode-back" href="../../../draw.html#graph_tool.draw.cairo_draw">[docs]</a><span class="k">def</span> <span class="nf">cairo_draw</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">vprops</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eprops</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vorder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eorder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">nodesfirst</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">vcmap</span><span class="o">=</span><span class="n">default_cm</span><span class="p">,</span> <span class="n">ecmap</span><span class="o">=</span><span class="n">default_cm</span><span class="p">,</span>
               <span class="n">loop_angle</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s">&quot;nan&quot;</span><span class="p">),</span> <span class="n">parallel_distance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fit_view</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">res</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">render_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_render_time</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    Draw a graph to a :mod:`cairo` context.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    g : :class:`~graph_tool.Graph`</span>
<span class="sd">        Graph to be drawn.</span>
<span class="sd">    pos : :class:`~graph_tool.PropertyMap`</span>
<span class="sd">        Vector-valued vertex property map containing the x and y coordinates of</span>
<span class="sd">        the vertices.</span>
<span class="sd">    cr : :class:`~cairo.Context`</span>
<span class="sd">        A :class:`~cairo.Context` instance.</span>
<span class="sd">    vprops : dict (optional, default: ``None``)</span>
<span class="sd">        Dictionary with the vertex properties. Individual properties may also be</span>
<span class="sd">        given via the ``vertex_&lt;prop-name&gt;`` parameters, where ``&lt;prop-name&gt;`` is</span>
<span class="sd">        the name of the property.</span>
<span class="sd">    eprops : dict (optional, default: ``None``)</span>
<span class="sd">        Dictionary with the vertex properties. Individual properties may also be</span>
<span class="sd">        given via the ``edge_&lt;prop-name&gt;`` parameters, where ``&lt;prop-name&gt;`` is</span>
<span class="sd">        the name of the property.</span>
<span class="sd">    vorder : :class:`~graph_tool.PropertyMap` (optional, default: ``None``)</span>
<span class="sd">        If provided, defines the relative order in which the vertices are drawn.</span>
<span class="sd">    eorder : :class:`~graph_tool.PropertyMap` (optional, default: ``None``)</span>
<span class="sd">        If provided, defines the relative order in which the edges are drawn.</span>
<span class="sd">    nodesfirst : bool (optional, default: ``False``)</span>
<span class="sd">        If ``True``, the vertices are drawn first, otherwise the edges are.</span>
<span class="sd">    vcmap : :class:`matplotlib.colors.Colormap` (optional, default: :class:`default_cm`)</span>
<span class="sd">        Vertex color map.</span>
<span class="sd">    ecmap : :class:`matplotlib.colors.Colormap` (optional, default: :class:`default_cm`)</span>
<span class="sd">        Edge color map.</span>
<span class="sd">    loop_angle : float or :class:`~graph_tool.PropertyMap` (optional, default: ``nan``)</span>
<span class="sd">        Angle used to draw self-loops. If ``nan`` is given, they will be placed</span>
<span class="sd">        radially from the center of the layout.</span>
<span class="sd">    parallel_distance : float (optional, default: ``None``)</span>
<span class="sd">        Distance used between parallel edges. If not provided, it will be</span>
<span class="sd">        determined automatically.</span>
<span class="sd">    fit_view : bool or float or tuple (optional, default: ``True``)</span>
<span class="sd">        If ``True``, the layout will be scaled to fit the entire clip region.</span>
<span class="sd">        If a float value is given, it will be interpreted as ``True``, and in</span>
<span class="sd">        addition the viewport will be scaled out by that factor. If a tuple</span>
<span class="sd">        value is given, it should have four values ``(x, y, w, h)`` that</span>
<span class="sd">        specify the view in user coordinates.</span>
<span class="sd">    bg_color : str or sequence (optional, default: ``None``)</span>
<span class="sd">        Background color. The default is transparent.</span>
<span class="sd">    res : float (optional, default: ``0.``):</span>
<span class="sd">        If shape sizes fall below this value, simplified drawing is used.</span>
<span class="sd">    render_offset : int (optional, default: ``0``):</span>
<span class="sd">        If supplied, the rendering will skip the specified initial amount of</span>
<span class="sd">        vertices / edges.</span>
<span class="sd">    max_render_time : int (optional, default: ``-1``):</span>
<span class="sd">        Maximum allowed time (in milliseconds) for rendering. If exceeded, the</span>
<span class="sd">        rendering will return unfinished. If negative values are given, the</span>
<span class="sd">        rendering will always complete.</span>
<span class="sd">    vertex_* : :class:`~graph_tool.PropertyMap` or arbitrary types (optional, default: ``None``)</span>
<span class="sd">        Parameters following the pattern ``vertex_&lt;prop-name&gt;`` specify the</span>
<span class="sd">        vertex property with name ``&lt;prop-name&gt;``, as an alternative to the</span>
<span class="sd">        ``vprops`` parameter.</span>
<span class="sd">    edge_* : :class:`~graph_tool.PropertyMap` or arbitrary types (optional, default: ``None``)</span>
<span class="sd">        Parameters following the pattern ``edge_&lt;prop-name&gt;`` specify the edge</span>
<span class="sd">        property with name ``&lt;prop-name&gt;``, as an alternative to the ``eprops``</span>
<span class="sd">        parameter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    offset : int</span>
<span class="sd">        The offset into the completed rendering. If this value is zero, the</span>
<span class="sd">        rendering was complete.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">vprops</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">vprops</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">vprops</span><span class="p">)</span>
    <span class="n">eprops</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">eprops</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">eprops</span><span class="p">)</span>

    <span class="n">props</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">parse_props</span><span class="p">(</span><span class="s">&quot;vertex&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="n">vprops</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
    <span class="n">props</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">parse_props</span><span class="p">(</span><span class="s">&quot;edge&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="n">eprops</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Unknown parameter: &quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

    <span class="n">cr</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">fit_view</span> <span class="o">!=</span> <span class="bp">False</span><span class="p">:</span>
        <span class="n">extents</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">clip_extents</span><span class="p">()</span>
        <span class="n">output_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">extents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">extents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">extents</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">fit_view</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">output_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">w</span><span class="p">,</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">y</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="n">fit_view</span> <span class="k">if</span> <span class="n">fit_view</span> <span class="o">!=</span> <span class="bp">True</span> <span class="k">else</span> <span class="mf">0.95</span>
            <span class="n">offset</span><span class="p">,</span> <span class="n">zoom</span> <span class="o">=</span> <span class="n">fit_to_view</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span>
                                       <span class="n">vprops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;size&quot;</span><span class="p">,</span> <span class="n">_vdefaults</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">]),</span>
                                       <span class="n">vprops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;pen_width&quot;</span><span class="p">,</span> <span class="n">_vdefaults</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">]),</span>
                                       <span class="bp">None</span><span class="p">,</span> <span class="n">vprops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;text&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                       <span class="n">vprops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;font_family&quot;</span><span class="p">,</span>
                                                  <span class="n">_vdefaults</span><span class="p">[</span><span class="s">&quot;font_family&quot;</span><span class="p">]),</span>
                                       <span class="n">vprops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;font_size&quot;</span><span class="p">,</span>
                                                  <span class="n">_vdefaults</span><span class="p">[</span><span class="s">&quot;font_size&quot;</span><span class="p">]),</span>
                                       <span class="n">pad</span><span class="p">,</span> <span class="n">cr</span><span class="p">)</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fit_view</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">zoom</span> <span class="o">/=</span> <span class="n">fit_view</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">zoom</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>

    <span class="k">if</span> <span class="s">&quot;control_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eprops</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parallel_distance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">parallel_distance</span> <span class="o">=</span> <span class="n">vprops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;size&quot;</span><span class="p">,</span> <span class="n">_vdefaults</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parallel_distance</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
                <span class="n">parallel_distance</span> <span class="o">=</span> <span class="n">parallel_distance</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">parallel_distance</span> <span class="o">/=</span> <span class="mf">1.5</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">get_matrix</span><span class="p">()</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">transform_scale</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="mi">1</span><span class="p">,)</span>
            <span class="n">parallel_distance</span> <span class="o">/=</span> <span class="n">scale</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;control_points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">position_parallel_edges</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">loop_angle</span><span class="p">,</span>
                                                           <span class="n">parallel_distance</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">is_directed</span><span class="p">()</span> <span class="ow">and</span> <span class="s">&quot;end_marker&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eprops</span><span class="p">:</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;end_marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;arrow&quot;</span>

    <span class="k">if</span> <span class="n">vprops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;text_position&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;centered&quot;</span><span class="p">:</span>
        <span class="n">angle</span><span class="p">,</span> <span class="n">tpos</span> <span class="o">=</span> <span class="n">centered_rotation</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">text_pos</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;text_position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpos</span>
        <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;text_rotation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>

    <span class="n">vattrs</span><span class="p">,</span> <span class="n">vdefaults</span> <span class="o">=</span> <span class="n">_attrs</span><span class="p">(</span><span class="n">vprops</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">vcmap</span><span class="p">)</span>
    <span class="n">eattrs</span><span class="p">,</span> <span class="n">edefaults</span> <span class="o">=</span> <span class="n">_attrs</span><span class="p">(</span><span class="n">eprops</span><span class="p">,</span> <span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">ecmap</span><span class="p">)</span>
    <span class="n">vdefs</span> <span class="o">=</span> <span class="n">_attrs</span><span class="p">(</span><span class="n">_vdefaults</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">vcmap</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">vdefs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">vdefaults</span><span class="p">)</span>
    <span class="n">edefs</span> <span class="o">=</span> <span class="n">_attrs</span><span class="p">(</span><span class="n">_edefaults</span><span class="p">,</span> <span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">ecmap</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">edefs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">edefaults</span><span class="p">)</span>

    <span class="k">if</span> <span class="s">&quot;control_points&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eprops</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parallel_distance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">parallel_distance</span> <span class="o">=</span> <span class="n">_defaults</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;control_points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">position_parallel_edges</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">loop_angle</span><span class="p">,</span>
                                                           <span class="n">parallel_distance</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">GraphView</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">directed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">libgraph_tool_draw</span><span class="o">.</span><span class="n">cairo_draw</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">_Graph__graph</span><span class="p">,</span> <span class="n">_prop</span><span class="p">(</span><span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span>
                                          <span class="n">_prop</span><span class="p">(</span><span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">vorder</span><span class="p">),</span> <span class="n">_prop</span><span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">eorder</span><span class="p">),</span>
                                          <span class="n">nodesfirst</span><span class="p">,</span> <span class="n">vattrs</span><span class="p">,</span> <span class="n">eattrs</span><span class="p">,</span> <span class="n">vdefs</span><span class="p">,</span> <span class="n">edefs</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span>
                                          <span class="n">render_offset</span><span class="p">,</span> <span class="n">max_render_time</span><span class="p">,</span> <span class="n">cr</span><span class="p">)</span>
    <span class="n">cr</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">count</span>
</div>
<span class="k">def</span> <span class="nf">color_contrast</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="o">.</span><span class="mi">299</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="o">.</span><span class="mi">587</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="o">.</span><span class="mi">114</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">5</span><span class="p">:</span>
        <span class="n">c</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">c</span>


<span class="k">def</span> <span class="nf">auto_colors</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">back</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="n">bgc</span> <span class="o">=</span> <span class="n">bg</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">bgc</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ColorConverter</span><span class="p">()</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">bg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bgc</span> <span class="o">=</span> <span class="n">bg</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="s">&quot;centered&quot;</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_contrast</span><span class="p">(</span><span class="n">bgc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_contrast</span><span class="p">(</span><span class="n">back</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span>

<div class="viewcode-block" id="graph_draw"><a class="viewcode-back" href="../../../draw.html#graph_tool.draw.graph_draw">[docs]</a><span class="k">def</span> <span class="nf">graph_draw</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vprops</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eprops</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vorder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eorder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">nodesfirst</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">output_size</span><span class="o">=</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">),</span> <span class="n">fit_view</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
               <span class="n">inline</span><span class="o">=</span><span class="n">is_draw_inline</span><span class="p">,</span> <span class="n">mplfig</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&quot;auto&quot;</span><span class="p">,</span>
               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;Draw a graph to screen or to a file using :mod:`cairo`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    g : :class:`~graph_tool.Graph`</span>
<span class="sd">        Graph to be drawn.</span>
<span class="sd">    pos : :class:`~graph_tool.PropertyMap` (optional, default: ``None``)</span>
<span class="sd">        Vector-valued vertex property map containing the x and y coordinates of</span>
<span class="sd">        the vertices. If not given, it will be computed using :func:`sfdp_layout`.</span>
<span class="sd">    vprops : dict (optional, default: ``None``)</span>
<span class="sd">        Dictionary with the vertex properties. Individual properties may also be</span>
<span class="sd">        given via the ``vertex_&lt;prop-name&gt;`` parameters, where ``&lt;prop-name&gt;`` is</span>
<span class="sd">        the name of the property.</span>
<span class="sd">    eprops : dict (optional, default: ``None``)</span>
<span class="sd">        Dictionary with the edge properties. Individual properties may also be</span>
<span class="sd">        given via the ``edge_&lt;prop-name&gt;`` parameters, where ``&lt;prop-name&gt;`` is</span>
<span class="sd">        the name of the property.</span>
<span class="sd">    vorder : :class:`~graph_tool.PropertyMap` (optional, default: ``None``)</span>
<span class="sd">        If provided, defines the relative order in which the vertices are drawn.</span>
<span class="sd">    eorder : :class:`~graph_tool.PropertyMap` (optional, default: ``None``)</span>
<span class="sd">        If provided, defines the relative order in which the edges are drawn.</span>
<span class="sd">    nodesfirst : bool (optional, default: ``False``)</span>
<span class="sd">        If ``True``, the vertices are drawn first, otherwise the edges are.</span>
<span class="sd">    output_size : tuple of scalars (optional, default: ``(600,600)``)</span>
<span class="sd">        Size of the drawing canvas. The units will depend on the output format</span>
<span class="sd">        (pixels for the screen, points for PDF, etc).</span>
<span class="sd">    fit_view : bool, float or tuple (optional, default: ``True``)</span>
<span class="sd">        If ``True``, the layout will be scaled to fit the entire clip region.</span>
<span class="sd">        If a float value is given, it will be interpreted as ``True``, and in</span>
<span class="sd">        addition the viewport will be scaled out by that factor. If a tuple</span>
<span class="sd">        value is given, it should have four values ``(x, y, w, h)`` that</span>
<span class="sd">        specify the view in user coordinates.</span>
<span class="sd">    inline : bool (optional, default: ``False``)</span>
<span class="sd">        If ``True`` and an `IPython notebook &lt;http://ipython.org/notebook&gt;`_  is</span>
<span class="sd">        being used, an inline version of the drawing will be returned.</span>
<span class="sd">    mplfig : :mod:`matplotlib` container object (optional, default: ``None``)</span>
<span class="sd">        The ``mplfig`` object needs to have an ``artists`` attribute. This can</span>
<span class="sd">        for example be a :class:`matplotlib.figure.Figure` or</span>
<span class="sd">        :class:`matplotlib.axes.Axes`. Only the cairo backend is supported; use</span>
<span class="sd">        ``switch_backend(&#39;cairo&#39;)``.</span>
<span class="sd">    output : string or file object (optional, default: ``None``)</span>
<span class="sd">        Output file name (or object). If not given, the graph will be displayed via</span>
<span class="sd">        :func:`interactive_window`.</span>
<span class="sd">    fmt : string (default: ``&quot;auto&quot;``)</span>
<span class="sd">        Output file format. Possible values are ``&quot;auto&quot;``, ``&quot;ps&quot;``, ``&quot;pdf&quot;``,</span>
<span class="sd">        ``&quot;svg&quot;``, and ``&quot;png&quot;``. If the value is ``&quot;auto&quot;``, the format is</span>
<span class="sd">        guessed from the ``output`` parameter.</span>
<span class="sd">    bg_color : str or sequence (optional, default: ``None``)</span>
<span class="sd">        Background color. The default is transparent.</span>
<span class="sd">    vertex_* : :class:`~graph_tool.PropertyMap` or arbitrary types (optional, default: ``None``)</span>
<span class="sd">        Parameters following the pattern ``vertex_&lt;prop-name&gt;`` specify the</span>
<span class="sd">        vertex property with name ``&lt;prop-name&gt;``, as an alternative to the</span>
<span class="sd">        ``vprops`` parameter.</span>
<span class="sd">    edge_* : :class:`~graph_tool.PropertyMap` or arbitrary types (optional, default: ``None``)</span>
<span class="sd">        Parameters following the pattern ``edge_&lt;prop-name&gt;`` specify the edge</span>
<span class="sd">        property with name ``&lt;prop-name&gt;``, as an alternative to the ``eprops``</span>
<span class="sd">        parameter.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Any extra parameters are passed to :func:`~graph_tool.draw.interactive_window`,</span>
<span class="sd">        :class:`~graph_tool.draw.GraphWindow`, :class:`~graph_tool.draw.GraphWidget`</span>
<span class="sd">        and :func:`~graph_tool.draw.cairo_draw`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pos : :class:`~graph_tool.PropertyMap`</span>
<span class="sd">        Vector vertex property map with the x and y coordinates of the vertices.</span>
<span class="sd">    selected : :class:`~graph_tool.PropertyMap` (optional, only if ``output is None``)</span>
<span class="sd">        Boolean-valued vertex property map marking the vertices which were</span>
<span class="sd">        selected interactively.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>


<span class="sd">    .. table:: **List of vertex properties**</span>

<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | Name          | Description                                       | Accepted types         | Default Value                    |</span>
<span class="sd">        +===============+===================================================+========================+==================================+</span>
<span class="sd">        | shape         | The vertex shape. Can be one of the following     | ``str`` or ``int``     | ``&quot;circle&quot;``                     |</span>
<span class="sd">        |               | strings: &quot;circle&quot;, &quot;triangle&quot;, &quot;square&quot;,          |                        |                                  |</span>
<span class="sd">        |               | &quot;pentagon&quot;, &quot;hexagon&quot;, &quot;heptagon&quot;, &quot;octagon&quot;      |                        |                                  |</span>
<span class="sd">        |               | &quot;double_circle&quot;, &quot;double_triangle&quot;,               |                        |                                  |</span>
<span class="sd">        |               | &quot;double_square&quot;, &quot;double_pentagon&quot;,               |                        |                                  |</span>
<span class="sd">        |               | &quot;double_hexagon&quot;, &quot;double_heptagon&quot;,              |                        |                                  |</span>
<span class="sd">        |               | &quot;double_octagon&quot;, &quot;pie&quot;.                          |                        |                                  |</span>
<span class="sd">        |               | Optionally, this might take a numeric value       |                        |                                  |</span>
<span class="sd">        |               | corresponding to position in the list above.      |                        |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | color         | Color used to stroke the lines of the vertex.     | ``str`` or list of     | ``[0., 0., 0., 1]``              |</span>
<span class="sd">        |               |                                                   | ``floats``             |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | fill_color    | Color used to fill the interior of the vertex.    | ``str`` or list of     | ``[0.640625, 0, 0, 0.9]``        |</span>
<span class="sd">        |               |                                                   | ``floats``             |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | size          | The size of the vertex, in the default units of   | ``float`` or ``int``   | ``5``                            |</span>
<span class="sd">        |               | the output format (normally either pixels or      |                        |                                  |</span>
<span class="sd">        |               | points).                                          |                        |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | aspect        | The aspect ratio of the vertex.                   | ``float`` or ``int``   | ``1.0``                          |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | anchor        | Specifies how the edges anchor to the vertices.   |  ``int``               | ``1``                            |</span>
<span class="sd">        |               | If `0`, the anchor is at the center of the vertex,|                        |                                  |</span>
<span class="sd">        |               | otherwise it is at the border.                    |                        |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | pen_width     | Width of the lines used to draw the vertex, in    | ``float`` or ``int``   | ``0.8``                          |</span>
<span class="sd">        |               | the default units of the output format (normally  |                        |                                  |</span>
<span class="sd">        |               | either pixels or points).                         |                        |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | halo          | Whether to draw a circular halo around the        | ``bool``               | ``False``                        |</span>
<span class="sd">        |               | vertex.                                           |                        |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | halo_color    | Color used to draw the halo.                      | ``str`` or list of     | ``[0., 0., 1., 0.5]``            |</span>
<span class="sd">        |               |                                                   | ``floats``             |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | halo_size     | Relative size of the halo.                        | ``float``              | ``1.5``                          |</span>
<span class="sd">        |               |                                                   |                        |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | text          | Text to draw together with the vertex.            | ``str``                | ``&quot;&quot;``                           |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | text_color    | Color used to draw the text. If the value is      | ``str`` or list of     | ``&quot;auto&quot;``                       |</span>
<span class="sd">        |               | ``&quot;auto&quot;``, it will be computed based on          | ``floats``             |                                  |</span>
<span class="sd">        |               | fill_color to maximize contrast.                  |                        |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | text_position | Position of the text relative to the vertex.      | ``float`` or ``int``   | ``-1``                           |</span>
<span class="sd">        |               | If the passed value is positive, it will          |  or ``&quot;centered&quot;``     |                                  |</span>
<span class="sd">        |               | correspond to an angle in radians, which will     |                        |                                  |</span>
<span class="sd">        |               | determine where the text will be placed outside   |                        |                                  |</span>
<span class="sd">        |               | the vertex. If the value is negative, the text    |                        |                                  |</span>
<span class="sd">        |               | will be placed inside the vertex. If the value is |                        |                                  |</span>
<span class="sd">        |               | ``-1``, the vertex size will be automatically     |                        |                                  |</span>
<span class="sd">        |               | increased to accommodate the text. The special    |                        |                                  |</span>
<span class="sd">        |               | value ``&quot;centered&quot;`` positions the texts rotated  |                        |                                  |</span>
<span class="sd">        |               | radially around the center of mass.               |                        |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | text_offset   | Text position offset.                             | list of ``float``      | ``[0.0, 0.0]``                   |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | text_rotation | Angle of rotation (in radians) for the text.      | ``float``              | ``0.0``                          |</span>
<span class="sd">        |               | The center of rotation is the position of the     |                        |                                  |</span>
<span class="sd">        |               | vertex.                                           |                        |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | font_family   | Font family used to draw the text.                | ``str``                | ``&quot;serif&quot;``                      |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | font_slant    | Font slant used to draw the text.                 | ``cairo.FONT_SLANT_*`` | :data:`cairo.FONT_SLANT_NORMAL`  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | font_weight   | Font weight used to draw the text.                | ``cairo.FONT_WEIGHT_*``| :data:`cairo.FONT_WEIGHT_NORMAL` |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | font_size     | Font size used to draw the text.                  | ``float`` or ``int``   | ``12``                           |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | surface       | The cairo surface used to draw the vertex. If     | :class:`cairo.Surface` | ``None``                         |</span>
<span class="sd">        |               | the value passed is a string, it is interpreted   | or ``str``             |                                  |</span>
<span class="sd">        |               | as an image file name to be loaded.               |                        |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | pie_fractions | Fractions of the pie sections for the vertices if | list of ``int`` or     | ``[0.75, 0.25]``                 |</span>
<span class="sd">        |               | ``shape==&quot;pie&quot;``.                                 | ``float``              |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | pie_colors    | Colors used in the pie sections if                | list of strings or     | ``(&#39;b&#39;,&#39;g&#39;,&#39;r&#39;,&#39;c&#39;,&#39;m&#39;,&#39;y&#39;,&#39;k&#39;)``|</span>
<span class="sd">        |               | ``shape==&quot;pie&quot;``.                                 | ``float``.             |                                  |</span>
<span class="sd">        +---------------+---------------------------------------------------+------------------------+----------------------------------+</span>


<span class="sd">    .. table:: **List of edge properties**</span>

<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | Name           | Description                                       | Accepted types         | Default Value                    |</span>
<span class="sd">        +================+===================================================+========================+==================================+</span>
<span class="sd">        | color          | Color used to stroke the edge lines.              | ``str`` or list of     | ``[0.179, 0.203,0.210, 0.8]``    |</span>
<span class="sd">        |                |                                                   | floats                 |                                  |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | pen_width      | Width of the line used to draw the edge, in       | ``float`` or ``int``   | ``1.0``                          |</span>
<span class="sd">        |                | the default units of the output format (normally  |                        |                                  |</span>
<span class="sd">        |                | either pixels or points).                         |                        |                                  |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | start_marker,  | Edge markers. Can be one of &quot;none&quot;, &quot;arrow&quot;,      | ``str`` or ``int``     | ``none``                         |</span>
<span class="sd">        | mid_marker,    | &quot;circle&quot;, &quot;square&quot;, &quot;diamond&quot;, or &quot;bar&quot;.          |                        |                                  |</span>
<span class="sd">        | end_marker     | Optionally, this might take a numeric value       |                        |                                  |</span>
<span class="sd">        |                | corresponding to position in the list above.      |                        |                                  |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | mid_marker_pos | Relative position of the middle marker.           | ``float``              | ``0.5``                          |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | marker_size    | Size of edge markers, in units appropriate to the | ``float`` or ``int``   | ``4``                            |</span>
<span class="sd">        |                | output format (normally either pixels or points). |                        |                                  |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | control_points | Control points of a Bézier spline used to draw    | sequence of ``floats`` | ``[]``                           |</span>
<span class="sd">        |                | the edge. Each spline segment requires 6 values   |                        |                                  |</span>
<span class="sd">        |                | corresponding to the (x,y) coordinates of the two |                        |                                  |</span>
<span class="sd">        |                | intermediary control points and the final point.  |                        |                                  |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | gradient       | Stop points of a linear gradient used to stroke   | sequence of ``floats`` | ``[]``                           |</span>
<span class="sd">        |                | the edge. Each group of 5 elements is interpreted |                        |                                  |</span>
<span class="sd">        |                | as ``[o, r, g, b, a]`` where ``o`` is the offset  |                        |                                  |</span>
<span class="sd">        |                | in the range [0, 1] and the remaining values      |                        |                                  |</span>
<span class="sd">        |                | specify the colors.                               |                        |                                  |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | dash_style     | Dash pattern is specified by an array of positive | sequence of ``floats`` | ``[]``                           |</span>
<span class="sd">        |                | values. Each value provides the length of         |                        |                                  |</span>
<span class="sd">        |                | alternate &quot;on&quot; and &quot;off&quot; portions of the stroke.  |                        |                                  |</span>
<span class="sd">        |                | The last value specifies an offset into the       |                        |                                  |</span>
<span class="sd">        |                | pattern at which the stroke begins.               |                        |                                  |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | text           | Text to draw next to the edges.                   | ``str``                | ``&quot;&quot;``                           |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | text_color     | Color used to draw the text.                      | ``str`` or list of     | ``[0., 0., 0., 1.]``             |</span>
<span class="sd">        |                |                                                   | ``floats``             |                                  |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | text_distance  | Distance from the edge and its text.              | ``float`` or ``int``   | ``4``                            |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | text_parallel  | If ``True`` the text will be drawn parallel to    | ``bool``               | ``True``                         |</span>
<span class="sd">        |                | the edges.                                        |                        |                                  |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | font_family    | Font family used to draw the text.                | ``str``                | ``&quot;serif&quot;``                      |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | font_slant     | Font slant used to draw the text.                 | ``cairo.FONT_SLANT_*`` | :data:`cairo.FONT_SLANT_NORMAL`  |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | font_weight    | Font weight used to draw the text.                | ``cairo.FONT_WEIGHT_*``| :data:`cairo.FONT_WEIGHT_NORMAL` |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>
<span class="sd">        | font_size      | Font size used to draw the text.                  | ``float`` or ``int``   | ``12``                           |</span>
<span class="sd">        +----------------+---------------------------------------------------+------------------------+----------------------------------+</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. testcode::</span>
<span class="sd">       :hide:</span>

<span class="sd">       np.random.seed(42)</span>
<span class="sd">       gt.seed_rng(42)</span>
<span class="sd">       from numpy import sqrt</span>

<span class="sd">    &gt;&gt;&gt; g = gt.price_network(1500)</span>
<span class="sd">    &gt;&gt;&gt; deg = g.degree_property_map(&quot;in&quot;)</span>
<span class="sd">    &gt;&gt;&gt; deg.a = 4 * (sqrt(deg.a) * 0.5 + 0.4)</span>
<span class="sd">    &gt;&gt;&gt; ebet = gt.betweenness(g)[1]</span>
<span class="sd">    &gt;&gt;&gt; ebet.a /= ebet.a.max() / 10.</span>
<span class="sd">    &gt;&gt;&gt; eorder = ebet.copy()</span>
<span class="sd">    &gt;&gt;&gt; eorder.a *= -1</span>
<span class="sd">    &gt;&gt;&gt; pos = gt.sfdp_layout(g)</span>
<span class="sd">    &gt;&gt;&gt; control = g.new_edge_property(&quot;vector&lt;double&gt;&quot;)</span>
<span class="sd">    &gt;&gt;&gt; for e in g.edges():</span>
<span class="sd">    ...     d = sqrt(sum((pos[e.source()].a - pos[e.target()].a) ** 2)) / 5</span>
<span class="sd">    ...     control[e] = [0.3, d, 0.7, d]</span>
<span class="sd">    &gt;&gt;&gt; gt.graph_draw(g, pos=pos, vertex_size=deg, vertex_fill_color=deg, vorder=deg,</span>
<span class="sd">    ...               edge_color=ebet, eorder=eorder, edge_pen_width=ebet,</span>
<span class="sd">    ...               edge_control_points=control, # some curvy edges</span>
<span class="sd">    ...               output=&quot;graph-draw.pdf&quot;)</span>
<span class="sd">    &lt;...&gt;</span>

<span class="sd">    .. testcode::</span>
<span class="sd">       :hide:</span>

<span class="sd">       gt.graph_draw(g, pos=pos, vertex_size=deg, vertex_fill_color=deg, vorder=deg,</span>
<span class="sd">                     edge_color=ebet, eorder=eorder, edge_pen_width=ebet,</span>
<span class="sd">                     edge_control_points=control,</span>
<span class="sd">                     output=&quot;graph-draw.png&quot;)</span>


<span class="sd">    .. figure:: graph-draw.*</span>
<span class="sd">        :align: center</span>

<span class="sd">        SFDP force-directed layout of a Price network with 1500 nodes. The</span>
<span class="sd">        vertex size and color indicate the degree, and the edge color and width</span>
<span class="sd">        the edge betweenness centrality.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">vprops</span> <span class="o">=</span> <span class="n">vprops</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">vprops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">eprops</span> <span class="o">=</span> <span class="n">eprops</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">eprops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="n">props</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">parse_props</span><span class="p">(</span><span class="s">&quot;vertex&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="n">vprops</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
    <span class="n">props</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">parse_props</span><span class="p">(</span><span class="s">&quot;edge&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="n">eprops</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">output</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="n">inline</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;update_layout&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)):</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">())</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">random_layout</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="p">[</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&quot;multilevel&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;multilevel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="s">&quot;layout_K&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;layout_K&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_avg_edge_distance</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">sfdp_layout</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_check_prop_vector</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;pos&quot;</span><span class="p">,</span> <span class="n">floating</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inline</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;layout_K&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;layout_K&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_avg_edge_distance</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&quot;update_layout&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;update_layout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="s">&quot;pen_width&quot;</span> <span class="ow">in</span> <span class="n">eprops</span> <span class="ow">and</span> <span class="s">&quot;marker_size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eprops</span><span class="p">:</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="n">pw</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">pw</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="mf">2.75</span>
            <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;marker_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pw</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;marker_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pw</span> <span class="o">*</span> <span class="mf">2.75</span>

    <span class="k">if</span> <span class="s">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">eprops</span> <span class="ow">and</span> <span class="s">&quot;text_distance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eprops</span> <span class="ow">and</span> <span class="s">&quot;pen_width&quot;</span> <span class="ow">in</span> <span class="n">eprops</span><span class="p">:</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="n">pw</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">pw</span><span class="o">.</span><span class="n">a</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;text_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pw</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;text_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pw</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="s">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">vprops</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&quot;text_color&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vprops</span> <span class="ow">or</span> <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;text_color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;auto&quot;</span><span class="p">):</span>
        <span class="n">vcmap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;vcmap&quot;</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">)</span>
        <span class="n">bg</span> <span class="o">=</span> <span class="n">_convert</span><span class="p">(</span><span class="n">vertex_attrs</span><span class="o">.</span><span class="n">fill_color</span><span class="p">,</span> <span class="n">vprops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;fill_color&quot;</span><span class="p">,</span> <span class="n">_vdefaults</span><span class="p">[</span><span class="s">&quot;fill_color&quot;</span><span class="p">]),</span> <span class="n">vcmap</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;bg_color&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">bg_color</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;bg_color&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bg_color</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
        <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;text_color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auto_colors</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span>
                                           <span class="n">vprops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;text_position&quot;</span><span class="p">,</span>
                                                      <span class="n">_vdefaults</span><span class="p">[</span><span class="s">&quot;text_position&quot;</span><span class="p">]),</span>
                                           <span class="n">bg_color</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mplfig</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mplfig</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">):</span>
            <span class="n">ctr</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">mplfig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mplfig</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">):</span>
            <span class="n">ctr</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">mplfig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctr</span> <span class="o">=</span> <span class="n">mplfig</span>

        <span class="n">artist</span> <span class="o">=</span> <span class="n">GraphArtist</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vprops</span><span class="p">,</span> <span class="n">eprops</span><span class="p">,</span> <span class="n">vorder</span><span class="p">,</span> <span class="n">eorder</span><span class="p">,</span> <span class="n">nodesfirst</span><span class="p">,</span>
                             <span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ctr</span><span class="o">.</span><span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">artist</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fit_view</span> <span class="o">!=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">fit_view</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ungroup_vector_property</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">l</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">b</span>
            <span class="k">if</span> <span class="n">fit_view</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fit_view</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fit_view</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="n">w</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">h</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pos</span>

    <span class="k">if</span> <span class="n">inline</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s">&quot;auto&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;png&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="n">get_file_fmt</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">output</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vprops</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
                <span class="n">vprops</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">_convert</span><span class="p">(</span><span class="n">vertex_attrs</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span>
                                     <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;vcmap&quot;</span><span class="p">,</span> <span class="n">default_cm</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">eprops</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
                <span class="n">eprops</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">_convert</span><span class="p">(</span><span class="n">edge_attrs</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span>
                                     <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;ecmap&quot;</span><span class="p">,</span> <span class="n">default_cm</span><span class="p">))</span>
        <span class="n">fit_area</span> <span class="o">=</span> <span class="n">fit_view</span> <span class="k">if</span> <span class="n">fit_view</span> <span class="o">!=</span> <span class="bp">True</span> <span class="k">else</span> <span class="mf">0.95</span>
        <span class="k">return</span> <span class="n">interactive_window</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vprops</span><span class="p">,</span> <span class="n">eprops</span><span class="p">,</span> <span class="n">vorder</span><span class="p">,</span> <span class="n">eorder</span><span class="p">,</span>
                                  <span class="n">nodesfirst</span><span class="p">,</span> <span class="n">fit_area</span><span class="o">=</span><span class="n">fit_area</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">auto_fmt</span> <span class="o">=</span> <span class="n">open_file</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;wb&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">output</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s">&quot;auto&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;File format must be specified.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">auto_fmt</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s">&quot;pdf&quot;</span><span class="p">:</span>
            <span class="n">srf</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">PDFSurface</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s">&quot;ps&quot;</span><span class="p">:</span>
            <span class="n">srf</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">PSSurface</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s">&quot;eps&quot;</span><span class="p">:</span>
            <span class="n">srf</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">PSSurface</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">srf</span><span class="o">.</span><span class="n">set_eps</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s">&quot;svg&quot;</span><span class="p">:</span>
            <span class="n">srf</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">SVGSurface</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s">&quot;png&quot;</span><span class="p">:</span>
            <span class="n">srf</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">ImageSurface</span><span class="p">(</span><span class="n">cairo</span><span class="o">.</span><span class="n">FORMAT_ARGB32</span><span class="p">,</span> <span class="n">output_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid format type: &quot;</span> <span class="o">+</span> <span class="n">fmt</span><span class="p">)</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">srf</span><span class="p">)</span>

        <span class="n">adjust_default_sizes</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">vprops</span><span class="p">,</span> <span class="n">eprops</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fit_view</span> <span class="o">!=</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">fit_view</span>
                <span class="n">offset</span><span class="p">,</span> <span class="n">zoom</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">pad</span> <span class="o">=</span> <span class="n">fit_view</span> <span class="k">if</span> <span class="n">fit_view</span> <span class="o">!=</span> <span class="bp">True</span> <span class="k">else</span> <span class="mf">0.95</span>
                <span class="n">offset</span><span class="p">,</span> <span class="n">zoom</span> <span class="o">=</span> <span class="n">fit_to_view</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">],</span>
                                           <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">],</span> <span class="bp">None</span><span class="p">,</span>
                                           <span class="n">vprops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;text&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                                           <span class="n">vprops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;font_family&quot;</span><span class="p">,</span>
                                                      <span class="n">_vdefaults</span><span class="p">[</span><span class="s">&quot;font_family&quot;</span><span class="p">]),</span>
                                           <span class="n">vprops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;font_size&quot;</span><span class="p">,</span>
                                                      <span class="n">_vdefaults</span><span class="p">[</span><span class="s">&quot;font_size&quot;</span><span class="p">]),</span>
                                           <span class="n">pad</span><span class="p">,</span> <span class="n">cr</span><span class="p">)</span>
                <span class="n">fit_view</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offset</span><span class="p">,</span> <span class="n">zoom</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="s">&quot;bg_color&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">bg_color</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;bg_color&quot;</span><span class="p">]</span>
            <span class="k">del</span>  <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;bg_color&quot;</span><span class="p">]</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">set_source_rgba</span><span class="p">(</span><span class="n">bg_color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bg_color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">bg_color</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bg_color</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">paint</span><span class="p">()</span>

        <span class="n">cr</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">zoom</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>

        <span class="n">cairo_draw</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">vprops</span><span class="p">,</span> <span class="n">eprops</span><span class="p">,</span> <span class="n">vorder</span><span class="p">,</span> <span class="n">eorder</span><span class="p">,</span>
                   <span class="n">nodesfirst</span><span class="p">,</span> <span class="n">fit_view</span><span class="o">=</span><span class="n">fit_view</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s">&quot;png&quot;</span><span class="p">:</span>
            <span class="n">srf</span><span class="o">.</span><span class="n">write_to_png</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">cr</span>

        <span class="k">if</span> <span class="n">inline</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s">&quot;png&quot;</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s">&quot;svg&quot;</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">SVG</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">inl_out</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
                <span class="n">inl_srf</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">ImageSurface</span><span class="p">(</span><span class="n">cairo</span><span class="o">.</span><span class="n">FORMAT_ARGB32</span><span class="p">,</span>
                                             <span class="n">output_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                             <span class="n">output_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">inl_cr</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">inl_srf</span><span class="p">)</span>
                <span class="n">inl_cr</span><span class="o">.</span><span class="n">set_source_surface</span><span class="p">(</span><span class="n">srf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">inl_cr</span><span class="o">.</span><span class="n">paint</span><span class="p">()</span>
                <span class="n">inl_srf</span><span class="o">.</span><span class="n">write_to_png</span><span class="p">(</span><span class="n">inl_out</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">inl_srf</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inl_out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
            <span class="n">srf</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">ofile</span><span class="p">,</span> <span class="n">auto_fmt</span> <span class="o">=</span> <span class="n">open_file</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;wb&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ofile</span> <span class="o">=</span> <span class="n">output_file</span>
                <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">ofile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">srf</span>
        <span class="k">return</span> <span class="n">pos</span>

</div>
<span class="k">def</span> <span class="nf">adjust_default_sizes</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">vprops</span><span class="p">,</span> <span class="n">eprops</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&quot;size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vprops</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">A</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.5</span>

    <span class="k">if</span> <span class="s">&quot;pen_width&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vprops</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vprops</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">],</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="s">&quot;pen_width&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eprops</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="s">&quot;marker_size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eprops</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;marker_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mf">0.8</span>


<span class="k">def</span> <span class="nf">scale_ink</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">vprops</span><span class="p">,</span> <span class="n">eprops</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&quot;size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vprops</span><span class="p">:</span>
        <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_vdefaults</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&quot;pen_width&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vprops</span><span class="p">:</span>
        <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_vdefaults</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&quot;font_size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vprops</span><span class="p">:</span>
        <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;font_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_vdefaults</span><span class="p">[</span><span class="s">&quot;font_size&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&quot;pen_width&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eprops</span><span class="p">:</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_edefaults</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&quot;marker_size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eprops</span><span class="p">:</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;marker_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_edefaults</span><span class="p">[</span><span class="s">&quot;marker_size&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&quot;font_size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eprops</span><span class="p">:</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;font_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_edefaults</span><span class="p">[</span><span class="s">&quot;font_size&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&quot;text_distance&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eprops</span><span class="p">:</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;text_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_edefaults</span><span class="p">[</span><span class="s">&quot;text_distance&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">props</span> <span class="ow">in</span> <span class="p">[</span><span class="n">vprops</span><span class="p">,</span> <span class="n">eprops</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">],</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="n">props</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fa</span> <span class="o">*=</span> <span class="n">scale</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">props</span><span class="p">[</span><span class="s">&quot;pen_width&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vprops</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">],</span> <span class="n">PropertyMap</span><span class="p">):</span>
        <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fa</span> <span class="o">*=</span> <span class="n">scale</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;size&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vprops</span><span class="p">[</span><span class="s">&quot;font_size&quot;</span><span class="p">],</span> <span class="n">PropertyMap</span><span class="p">):</span>
        <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;font_size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fa</span> <span class="o">*=</span> <span class="n">scale</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vprops</span><span class="p">[</span><span class="s">&quot;font_size&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eprops</span><span class="p">[</span><span class="s">&quot;marker_size&quot;</span><span class="p">],</span> <span class="n">PropertyMap</span><span class="p">):</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;marker_size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fa</span> <span class="o">*=</span> <span class="n">scale</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;marker_size&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eprops</span><span class="p">[</span><span class="s">&quot;font_size&quot;</span><span class="p">],</span> <span class="n">PropertyMap</span><span class="p">):</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;font_size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fa</span> <span class="o">*=</span> <span class="n">scale</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;font_size&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eprops</span><span class="p">[</span><span class="s">&quot;text_distance&quot;</span><span class="p">],</span> <span class="n">PropertyMap</span><span class="p">):</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;text_distance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fa</span> <span class="o">*=</span> <span class="n">scale</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;text_distance&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale</span>

<span class="k">def</span> <span class="nf">get_bb</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pen_width</span><span class="p">,</span> <span class="n">size_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">font_family</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
           <span class="n">font_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">fa</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">)</span> <span class="k">else</span> <span class="n">size</span>
    <span class="n">pen_width</span> <span class="o">=</span> <span class="n">pen_width</span><span class="o">.</span><span class="n">fa</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pen_width</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">)</span> <span class="k">else</span> <span class="n">pen_width</span>
    <span class="n">pos_x</span><span class="p">,</span> <span class="n">pos_y</span> <span class="o">=</span> <span class="n">ungroup_vector_property</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="n">uniform</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">font_size</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">)</span> <span class="ow">and</span>
                       <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">font_family</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">))</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_x</span><span class="o">.</span><span class="n">fa</span><span class="p">))</span> <span class="o">*</span> <span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uniform</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertices</span><span class="p">()):</span>
            <span class="n">ff</span> <span class="o">=</span> <span class="n">font_family</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">font_family</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">)</span> \
               <span class="k">else</span> <span class="n">font_family</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">select_font_face</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="n">font_size</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">font_family</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">)</span> \
               <span class="k">else</span> <span class="n">font_size</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">font_size</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">set_font_size</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">)</span> <span class="k">else</span> <span class="n">text</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">extents</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">text_extents</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">extents</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">extents</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1.4</span>
            <span class="n">size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">size_scale</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">size_scale</span>
            <span class="k">if</span> <span class="n">uniform</span><span class="p">:</span>
                <span class="n">size</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">break</span>
    <span class="n">sl</span> <span class="o">=</span> <span class="n">label_self_loops</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">slm</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.75</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">size_scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">slm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pen_width</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">x_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos_x</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">pos_x</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
    <span class="n">y_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos_y</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">pos_y</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
    <span class="n">x_delta</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_x</span><span class="o">.</span><span class="n">fa</span> <span class="o">-</span> <span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
               <span class="p">(</span><span class="n">pos_x</span><span class="o">.</span><span class="n">fa</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">y_delta</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_y</span><span class="o">.</span><span class="n">fa</span> <span class="o">-</span> <span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
               <span class="p">(</span><span class="n">pos_y</span><span class="o">.</span><span class="n">fa</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">x_delta</span><span class="p">,</span> <span class="n">y_delta</span>


<span class="k">def</span> <span class="nf">fit_to_view</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pen_width</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">font_family</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">cr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pos_x</span><span class="p">,</span> <span class="n">pos_y</span> <span class="o">=</span> <span class="n">ungroup_vector_property</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_x</span><span class="o">.</span><span class="n">fa</span><span class="p">)))</span>
        <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">pos_x</span><span class="o">.</span><span class="n">fa</span>
        <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">pos_y</span><span class="o">.</span><span class="n">fa</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">O</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">O</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">O</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">O</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pos_x</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">pos_y</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">group_vector_property</span><span class="p">([</span><span class="n">pos_x</span><span class="p">,</span> <span class="n">pos_y</span><span class="p">])</span>
    <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">x_delta</span><span class="p">,</span> <span class="n">y_delta</span> <span class="o">=</span> <span class="n">get_bb</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pen_width</span><span class="p">,</span>
                                                <span class="mi">1</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">font_family</span><span class="p">,</span>
                                                <span class="n">font_size</span><span class="p">,</span> <span class="n">cr</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">dx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">dy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">zoom_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x_delta</span><span class="p">))</span> <span class="o">/</span> <span class="n">dx</span>
    <span class="n">zoom_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y_delta</span><span class="p">))</span> <span class="o">/</span> <span class="n">dy</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">zoom_x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">zoom_x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">zoom_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">zoom_x</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">zoom_y</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">zoom_y</span><span class="p">)</span> <span class="ow">or</span> <span class="n">zoom_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">zoom_y</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">zoom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">zoom_x</span><span class="p">,</span> <span class="n">zoom_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">pad</span>
    <span class="n">empty_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x_delta</span><span class="p">))</span> <span class="o">-</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">zoom</span>
    <span class="n">empty_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y_delta</span><span class="p">))</span> <span class="o">-</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">zoom</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">zoom</span> <span class="o">+</span> <span class="n">empty_x</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">x_delta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
              <span class="o">-</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">zoom</span> <span class="o">+</span> <span class="n">empty_y</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">y_delta</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">zoom</span>


<span class="k">def</span> <span class="nf">transform_scale</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">transform_distance</span><span class="p">(</span><span class="n">scale</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                             <span class="n">scale</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="get_hierarchy_control_points"><a class="viewcode-back" href="../../../draw.html#graph_tool.draw.get_hierarchy_control_points">[docs]</a><span class="k">def</span> <span class="nf">get_hierarchy_control_points</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">tpos</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">cts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;Return the Bézier spline control points for the edges in ``g``, given the hierarchical structure encoded in graph `t`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    g : :class:`~graph_tool.Graph`</span>
<span class="sd">        Graph to be drawn.</span>
<span class="sd">    t : :class:`~graph_tool.Graph`</span>
<span class="sd">        Directed graph containing the hierarchy of ``g``. It must be a directed</span>
<span class="sd">        tree with a single root. The direction of the edges point from the root</span>
<span class="sd">        to the leaves, and the vertices in ``t`` with index in the range</span>
<span class="sd">        :math:`[0, N-1]`, with :math:`N` being the number of vertices in ``g``,</span>
<span class="sd">        must correspond to the respective vertex in ``g``.</span>
<span class="sd">    tpos : :class:`~graph_tool.PropertyMap`</span>
<span class="sd">        Vector-valued vertex property map containing the x and y coordinates of</span>
<span class="sd">        the vertices in graph ``t``.</span>
<span class="sd">    beta : ``float`` (optional, default: ``0.8`` or :class:`~graph_tool.PropertyMap`)</span>
<span class="sd">        Edge bundling strength. For ``beta == 0`` the edges are straight lines,</span>
<span class="sd">        and for ``beta == 1`` they strictly follow the hierarchy. This can be</span>
<span class="sd">        optionally an edge property map, which specified a different bundling</span>
<span class="sd">        strength for each edge.</span>
<span class="sd">    cts : :class:`~graph_tool.PropertyMap` (optional, default: ``None``)</span>
<span class="sd">        Edge property map of type ``vector&lt;double&gt;`` where the control points</span>
<span class="sd">        will be stored.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    cts : :class:`~graph_tool.PropertyMap`</span>
<span class="sd">        Vector-valued edge property map containing the Bézier spline control</span>
<span class="sd">        points for the edges in ``g``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This is an implementation of the edge-bundling algorithm described in</span>
<span class="sd">    [holten-hierarchical-2006]_.</span>


<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. testsetup:: nested_cts</span>

<span class="sd">       gt.seed_rng(42)</span>
<span class="sd">       np.random.seed(42)</span>

<span class="sd">    .. doctest:: nested_cts</span>

<span class="sd">       &gt;&gt;&gt; g = gt.collection.data[&quot;netscience&quot;]</span>
<span class="sd">       &gt;&gt;&gt; g = gt.GraphView(g, vfilt=gt.label_largest_component(g))</span>
<span class="sd">       &gt;&gt;&gt; g.purge_vertices()</span>
<span class="sd">       &gt;&gt;&gt; state = gt.minimize_nested_blockmodel_dl(g, deg_corr=True)</span>
<span class="sd">       &gt;&gt;&gt; t = gt.get_hierarchy_tree(state)[0]</span>
<span class="sd">       &gt;&gt;&gt; tpos = pos = gt.radial_tree_layout(t, t.vertex(t.num_vertices() - 1), weighted=True)</span>
<span class="sd">       &gt;&gt;&gt; cts = gt.get_hierarchy_control_points(g, t, tpos)</span>
<span class="sd">       &gt;&gt;&gt; pos = g.own_property(tpos)</span>
<span class="sd">       &gt;&gt;&gt; b = state.levels[0].b</span>
<span class="sd">       &gt;&gt;&gt; shape = b.copy()</span>
<span class="sd">       &gt;&gt;&gt; shape.a %= 14</span>
<span class="sd">       &gt;&gt;&gt; gt.graph_draw(g, pos=pos, vertex_fill_color=b, vertex_shape=shape, edge_control_points=cts,</span>
<span class="sd">       ...               edge_color=[0, 0, 0, 0.3], vertex_anchor=0, output=&quot;netscience_nested_mdl.pdf&quot;)</span>
<span class="sd">       &lt;...&gt;</span>

<span class="sd">    .. testcleanup:: nested_cts</span>

<span class="sd">       gt.graph_draw(g, pos=pos, vertex_fill_color=b, vertex_shape=shape, edge_control_points=cts, edge_color=[0, 0, 0, 0.3], vertex_anchor=0, output=&quot;netscience_nested_mdl.png&quot;)</span>

<span class="sd">    .. figure:: netscience_nested_mdl.*</span>
<span class="sd">       :align: center</span>

<span class="sd">       Block partition of a co-authorship network, which minimizes the description</span>
<span class="sd">       length of the network according to the nested (degree-corrected) stochastic blockmodel.</span>



<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    .. [holten-hierarchical-2006] Holten, D. &quot;Hierarchical Edge Bundles:</span>
<span class="sd">       Visualization of Adjacency Relations in Hierarchical Data.&quot;, IEEE</span>
<span class="sd">       Transactions on Visualization and Computer Graphics 12, no. 5, 741–748</span>
<span class="sd">       (2006). :doi:`10.1109/TVCG.2006.147`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">cts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cts</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cts</span><span class="o">.</span><span class="n">value_type</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;cts property map must be of type &#39;vector&lt;double&gt;&#39; not &#39;</span><span class="si">%s</span><span class="s">&#39; &quot;</span> <span class="o">%</span> <span class="n">cts</span><span class="o">.</span><span class="n">value_type</span><span class="p">())</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">GraphView</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">directed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">tu</span> <span class="o">=</span> <span class="n">GraphView</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">directed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">)</span>

    <span class="n">libgraph_tool_draw</span><span class="o">.</span><span class="n">get_cts</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">_Graph__graph</span><span class="p">,</span> <span class="n">tu</span><span class="o">.</span><span class="n">_Graph__graph</span><span class="p">,</span>
                               <span class="n">_prop</span><span class="p">(</span><span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="n">tu</span><span class="p">,</span> <span class="n">tpos</span><span class="p">),</span>
                               <span class="n">_prop</span><span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">beta</span><span class="p">),</span>
                               <span class="n">_prop</span><span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">cts</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cts</span>

<span class="c">#</span>
<span class="c"># The functions and classes below depend on GTK</span>
<span class="c"># =============================================</span>
<span class="c">#</span>
</div>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">gi.repository</span> <span class="kn">import</span> <span class="n">Gtk</span><span class="p">,</span> <span class="n">Gdk</span><span class="p">,</span> <span class="n">GdkPixbuf</span>
    <span class="kn">from</span> <span class="nn">gi.repository</span> <span class="kn">import</span> <span class="n">GObject</span> <span class="k">as</span> <span class="n">gobject</span>
    <span class="kn">from</span> <span class="nn">.gtk_draw</span> <span class="kn">import</span> <span class="o">*</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Error importing Gtk module: </span><span class="si">%s</span><span class="s">; GTK+ drawing will not work.&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gen_surface</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">fobj</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">=</span> <span class="n">open_file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;png&quot;</span><span class="p">,</span> <span class="s">&quot;PNG&quot;</span><span class="p">]:</span>
        <span class="n">sfc</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">ImageSurface</span><span class="o">.</span><span class="n">create_from_png</span><span class="p">(</span><span class="n">fobj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sfc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pixbuf</span> <span class="o">=</span> <span class="n">GdkPixbuf</span><span class="o">.</span><span class="n">Pixbuf</span><span class="o">.</span><span class="n">new_from_file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">ImageSurface</span><span class="p">(</span><span class="n">cairo</span><span class="o">.</span><span class="n">FORMAT_ARGB32</span><span class="p">,</span> <span class="n">pixbuf</span><span class="o">.</span><span class="n">get_width</span><span class="p">(),</span>
                                     <span class="n">pixbuf</span><span class="o">.</span><span class="n">get_height</span><span class="p">())</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
        <span class="n">Gdk</span><span class="o">.</span><span class="n">cairo_set_source_pixbuf</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">pixbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">paint</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">surface</span>
<span class="c">#</span>
<span class="c"># matplotlib</span>
<span class="c"># ==========</span>
<span class="c">#</span>

<span class="k">class</span> <span class="nc">GraphArtist</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">Artist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;:class:`matplotlib.artist.Artist` specialization that draws</span>
<span class="sd">       :class:`graph_tool.Graph` instances.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        Only Cairo-based backends are supported.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vprops</span><span class="p">,</span> <span class="n">eprops</span><span class="p">,</span> <span class="n">vorder</span><span class="p">,</span> <span class="n">eorder</span><span class="p">,</span>
                <span class="n">nodesfirst</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">Artist</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vprops</span> <span class="o">=</span> <span class="n">vprops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eprops</span> <span class="o">=</span> <span class="n">eprops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vorder</span> <span class="o">=</span> <span class="n">vorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eorder</span> <span class="o">=</span> <span class="n">eorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodesfirst</span> <span class="o">=</span> <span class="n">nodesfirst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">renderer</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">backend_cairo</span><span class="o">.</span><span class="n">RendererCairo</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;graph plotting is supported only on Cairo backends&quot;</span><span class="p">)</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">renderer</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ctx</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">get_affine</span><span class="p">()</span><span class="o">.</span><span class="n">get_matrix</span><span class="p">()</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">set_matrix</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

            <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="o">-</span><span class="n">l</span><span class="p">,</span> <span class="n">t</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>
            <span class="n">ctx</span><span class="o">.</span><span class="n">clip</span><span class="p">()</span>


        <span class="n">cairo_draw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vprops</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eprops</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">vorder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eorder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodesfirst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ctx</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>


<span class="c">#</span>
<span class="c"># Drawing hierarchies</span>
<span class="c"># ===================</span>
<span class="c">#</span>

<div class="viewcode-block" id="draw_hierarchy"><a class="viewcode-back" href="../../../draw.html#graph_tool.draw.draw_hierarchy">[docs]</a><span class="k">def</span> <span class="nf">draw_hierarchy</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s">&quot;radial&quot;</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ealpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                   <span class="n">halpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">subsample_edges</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">deg_order</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">deg_size</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">vsize_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hsize_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">empty_branches</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;Draw a nested block model state in a circular hierarchy layout with edge</span>
<span class="sd">    bundling.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    state : :class:`~graph_tool.community.NestedBlockState`</span>
<span class="sd">        Nested block state to be drawn.</span>
<span class="sd">    pos : :class:`~graph_tool.PropertyMap` (optional, default: ``None``)</span>
<span class="sd">        If supplied, this specifies a vertex property map with the positions of</span>
<span class="sd">        the vertices in the layout.</span>
<span class="sd">    layout : ``str`` or :class:`~graph_tool.PropertyMap` (optional, default: ``&quot;radial&quot;``)</span>
<span class="sd">        If ``layout == &quot;radial&quot;`` :func:`~graph_tool.draw.radial_tree_layout`</span>
<span class="sd">        will be used. If ``layout == &quot;sfdp&quot;``, the hierarchy tree will be</span>
<span class="sd">        positioned using :func:`~graph_tool.draw.sfdp_layout`. If a</span>
<span class="sd">        :class:`~graph_tool.PropertyMap` is provided, it must correspond to the</span>
<span class="sd">        position of the hierarchy tree.</span>
<span class="sd">    beta : ``float`` (optional, default: ``.8``)</span>
<span class="sd">        Edge bundling strength.</span>
<span class="sd">    ealpha : ``float`` (optional, default: ``.8``)</span>
<span class="sd">        Alpha value of the edge colors.</span>
<span class="sd">    halpha : ``float`` (optional, default: ``.8``)</span>
<span class="sd">        Alpha value of hierarchy nodes and edges.</span>
<span class="sd">    subsample_edges : ``int`` or list of :class:`~graph_tool.Edge` instances (optional, default: ``None``)</span>
<span class="sd">        If provided, only this number of random edges will be drawn. If the</span>
<span class="sd">        value is a list, it should include the edges that are to be drawn.</span>
<span class="sd">    deg_order : ``bool`` (optional, default: ``True``)</span>
<span class="sd">        If ``True``, the vertices will be ordered according to degree inside</span>
<span class="sd">        each group.</span>
<span class="sd">    vsize_scale : ``float`` (optional, default: ``1.``)</span>
<span class="sd">        Multiplicative factor of the vertex sizes.</span>
<span class="sd">    hsize_scale : ``float`` (optional, default: ``1.``)</span>
<span class="sd">        Multiplicative factor of the sizes of the hierarchy nodes.</span>
<span class="sd">    empty_branches : ``bool`` (optional, default: ``False``)</span>
<span class="sd">       If ``empty_branches == False``, dangling branches at the upper layers</span>
<span class="sd">       will be pruned.</span>
<span class="sd">    verbose : ``bool`` (optional, default: ``False``)</span>
<span class="sd">       If ``verbose == True``, verbose information will be displayed.</span>
<span class="sd">    **kwargs :</span>
<span class="sd">       All remaining keyword arguments will be passed to the</span>
<span class="sd">       :func:`~graph_tool.draw.graph_draw` function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    pos : :class:`~graph_tool.PropertyMap`</span>
<span class="sd">        This is a vertex property map with the positions of</span>
<span class="sd">        the vertices in the layout.</span>
<span class="sd">    t : :class:`~graph_tool.Graph`</span>
<span class="sd">        This is a the hierarchy tree used in the layout.</span>
<span class="sd">    tpos : :class:`~graph_tool.PropertyMap`</span>
<span class="sd">        This is a vertex property map with the positions of</span>
<span class="sd">        the hierarchy tree in the layout.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. testsetup:: draw_hierarchy</span>

<span class="sd">       gt.seed_rng(42)</span>
<span class="sd">       np.random.seed(42)</span>

<span class="sd">    .. doctest:: draw_hierarchy</span>

<span class="sd">       &gt;&gt;&gt; g = gt.collection.data[&quot;celegansneural&quot;]</span>
<span class="sd">       &gt;&gt;&gt; state = gt.minimize_nested_blockmodel_dl(g, deg_corr=True)</span>
<span class="sd">       &gt;&gt;&gt; gt.draw_hierarchy(state, output=&quot;celegansneural_nested_mdl.pdf&quot;)</span>
<span class="sd">       (...)</span>

<span class="sd">    .. testcleanup:: draw_hierarchy</span>

<span class="sd">       gt.draw_hierarchy(state, output=&quot;celegansneural_nested_mdl.png&quot;)</span>

<span class="sd">    .. figure:: celegansneural_nested_mdl.*</span>
<span class="sd">       :align: center</span>

<span class="sd">       Hierarchical block partition of the C. elegans neural network, which</span>
<span class="sd">       minimizes the description length of the network according to the nested</span>
<span class="sd">       (degree-corrected) stochastic blockmodel.</span>


<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [holten-hierarchical-2006] Holten, D. &quot;Hierarchical Edge Bundles:</span>
<span class="sd">       Visualization of Adjacency Relations in Hierarchical Data.&quot;, IEEE</span>
<span class="sd">       Transactions on Visualization and Computer Graphics 12, no. 5, 741–748</span>
<span class="sd">       (2006). :doi:`10.1109/TVCG.2006.147`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">g</span>

    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">overlap</span><span class="p">:</span>
        <span class="n">ostate</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bv</span><span class="p">,</span> <span class="n">bcin</span><span class="p">,</span> <span class="n">bcout</span><span class="p">,</span> <span class="n">bc</span> <span class="o">=</span> <span class="n">ostate</span><span class="o">.</span><span class="n">get_overlap_blocks</span><span class="p">()</span>
        <span class="n">be</span> <span class="o">=</span> <span class="n">ostate</span><span class="o">.</span><span class="n">get_edge_blocks</span><span class="p">()</span>
        <span class="n">orig_state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">ostate</span><span class="o">.</span><span class="n">get_majority_blocks</span><span class="p">()</span>
        <span class="n">state</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BlockState</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">b</span>

    <span class="k">if</span> <span class="n">subsample_edges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;subsampling edges...&quot;</span><span class="p">)</span>
        <span class="n">emask</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;bool&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subsample_edges</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">eidx</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s">&quot;int&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fa</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">eidx</span><span class="p">)</span>
            <span class="n">emask</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;bool&quot;</span><span class="p">)</span>
            <span class="n">emask</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">eidx</span><span class="p">[:</span><span class="n">subsample_edges</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">subsample_edges</span><span class="p">:</span>
                <span class="n">emask</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">GraphView</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">efilt</span><span class="o">=</span><span class="n">emask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;done.&quot;</span><span class="p">)</span>

    <span class="n">t</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">vorder</span> <span class="o">=</span> <span class="n">get_hierarchy_tree</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">empty_branches</span><span class="o">=</span><span class="n">empty_branches</span><span class="p">)</span>

    <span class="n">edge_labels</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;string&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">layout</span> <span class="o">==</span> <span class="s">&quot;radial&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deg_order</span><span class="p">:</span>
            <span class="n">vorder</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ungroup_vector_property</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">x</span><span class="o">.</span><span class="n">a</span> <span class="o">-=</span> <span class="n">x</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">y</span><span class="o">.</span><span class="n">a</span> <span class="o">-=</span> <span class="n">y</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">)</span>
            <span class="n">angle</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">vorder</span> <span class="o">=</span> <span class="n">angle</span>
        <span class="n">tpos</span> <span class="o">=</span> <span class="n">radial_tree_layout</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">rel_order</span><span class="o">=</span><span class="n">vorder</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">layout</span> <span class="o">==</span> <span class="s">&quot;sfdp&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tpos</span> <span class="o">=</span> <span class="n">sfdp_layout</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ungroup_vector_property</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">x</span><span class="o">.</span><span class="n">a</span> <span class="o">-=</span> <span class="n">x</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">y</span><span class="o">.</span><span class="n">a</span> <span class="o">-=</span> <span class="n">y</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="n">y</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="o">/</span> <span class="mi">10</span>
            <span class="n">tpos</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">():</span>
                    <span class="n">tpos</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">v</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tpos</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pin</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;bool&quot;</span><span class="p">)</span>
            <span class="n">pin</span><span class="o">.</span><span class="n">a</span><span class="p">[:</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">tpos</span> <span class="o">=</span> <span class="n">sfdp_layout</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">tpos</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="n">pin</span><span class="p">,</span> <span class="n">multilevel</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tpos</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">own_property</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">own_property</span><span class="p">(</span><span class="n">tpos</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;getting cts...&quot;</span><span class="p">)</span>

    <span class="n">cts</span> <span class="o">=</span> <span class="n">get_hierarchy_control_points</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">tpos</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;done.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;putting gradient...&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">kwargs</span>
    <span class="n">vcmap</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;vcmap&quot;</span><span class="p">,</span> <span class="n">default_cm</span><span class="p">)</span>
    <span class="n">ecmap</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;ecmap&quot;</span><span class="p">,</span> <span class="n">vcmap</span><span class="p">)</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">B</span>

    <span class="n">gradient</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;edge_gradient&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gradient</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">gradient</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">)</span>
        <span class="n">gradient</span> <span class="o">=</span> <span class="n">group_vector_property</span><span class="p">([</span><span class="n">gradient</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">overlap</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">be</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">source</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">.</span><span class="n">target</span><span class="p">():</span>
                    <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">r</span>
                <span class="n">gradient</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">vcmap</span><span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">+</span> \
                              <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">vcmap</span><span class="p">(</span><span class="n">s</span> <span class="o">/</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
                <span class="n">gradient</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">ealpha</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;done&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;putting color...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;edge_color&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">edge_color</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;edge_color&quot;</span><span class="p">)</span>
        <span class="n">edge_color</span> <span class="o">=</span> <span class="n">_convert</span><span class="p">(</span><span class="n">edge_attrs</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> <span class="n">edge_color</span><span class="p">,</span>
                              <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;ecmap&quot;</span><span class="p">,</span> <span class="n">default_cm</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_color</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">edge_color</span>
            <span class="n">clrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">clrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">edge_color</span> <span class="o">=</span> <span class="n">group_vector_property</span><span class="p">(</span><span class="n">clrs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">,</span> <span class="n">ealpha</span><span class="p">)</span>
        <span class="n">edge_color</span> <span class="o">=</span> <span class="n">group_vector_property</span><span class="p">([</span><span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">a</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;done&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;putting tcolor...&quot;</span><span class="p">)</span>
    <span class="n">tedge_color</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">,</span>  <span class="nb">int</span><span class="p">(</span><span class="s">&quot;a4&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">,</span> <span class="n">halpha</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">)</span>
    <span class="n">tedge_color</span> <span class="o">=</span> <span class="n">group_vector_property</span><span class="p">([</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">a</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;done&quot;</span><span class="p">)</span>

    <span class="n">em</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">is_directed</span><span class="p">())</span>
    <span class="n">tem</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">epw</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;edge_pen_width&quot;</span><span class="p">,</span>
                   <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">tepw</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">vlabels</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;vertex_text&quot;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;string&quot;</span><span class="p">))</span>
    <span class="n">tlabels</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;string&quot;</span><span class="p">)</span>

    <span class="n">t_orig</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">GraphView</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">vfilt</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;joining graphs&quot;</span><span class="p">)</span>
    <span class="n">props</span> <span class="o">=</span> <span class="p">[(</span><span class="n">pos</span><span class="p">,</span> <span class="n">tpos</span><span class="p">),</span>
             <span class="p">(</span><span class="n">cts</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
             <span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
             <span class="p">(</span><span class="n">edge_color</span><span class="p">,</span> <span class="n">tedge_color</span><span class="p">),</span>
             <span class="p">(</span><span class="n">em</span><span class="p">,</span> <span class="n">tem</span><span class="p">),</span>
             <span class="p">(</span><span class="n">epw</span><span class="p">,</span> <span class="n">tepw</span><span class="p">),</span>
             <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;edge_text&quot;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;string&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s">&quot;string&quot;</span><span class="p">),</span>
              <span class="n">edge_labels</span><span class="p">),</span>
             <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">vertex_index</span><span class="p">,</span> <span class="n">tb</span><span class="p">),</span>
             <span class="p">(</span><span class="n">vlabels</span><span class="p">,</span> <span class="n">tlabels</span><span class="p">)]</span>

    <span class="c"># propagate all other properties in args</span>
    <span class="n">arg_pos</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">key_type</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&quot;v&quot;</span><span class="p">:</span>
            <span class="n">props</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
            <span class="n">arg_pos</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">props</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">u</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="n">graph_union</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="n">props</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;done&quot;</span><span class="p">)</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cts</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">egradient</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ecolor</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">em</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">epw</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">elabels</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">vertex_text</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">own_property</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arg_pos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">args</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

    <span class="n">vshape</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;int&quot;</span><span class="p">)</span>
    <span class="n">vshape</span><span class="o">.</span><span class="n">a</span><span class="p">[:</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">vshape</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">():]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="s">&quot;vertex_shape&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">vshape</span><span class="o">.</span><span class="n">a</span><span class="p">[:</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;vertex_shape&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">a</span><span class="p">[:</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()]</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;vertex_shape&quot;</span><span class="p">]</span>

    <span class="n">vsize</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">deg_size</span><span class="p">:</span>
        <span class="n">vsize</span> <span class="o">=</span> <span class="n">prop_to_size</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degree_property_map</span><span class="p">(</span><span class="s">&quot;total&quot;</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

    <span class="k">if</span> <span class="s">&quot;vertex_size&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">vsize</span><span class="o">.</span><span class="n">a</span><span class="p">[:</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;vertex_size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">a</span><span class="p">[:</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()]</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;vertex_size&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">vsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">vsize</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">():]</span> <span class="o">=</span> <span class="n">vsize</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">():]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">hsize_scale</span> <span class="o">*</span> <span class="mf">1.5</span>

        <span class="n">ems</span> <span class="o">=</span> <span class="n">epw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ems</span><span class="o">.</span><span class="n">a</span> <span class="o">*=</span> <span class="mf">2.75</span>
        <span class="n">ems</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">num_edges</span><span class="p">():]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vsize</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">():]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">hsize_scale</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="n">vsize</span><span class="o">.</span><span class="n">a</span><span class="p">[:</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()]</span> <span class="o">*=</span> <span class="n">vsize_scale</span>

    <span class="n">vorder</span> <span class="o">=</span> <span class="n">vsize</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">vorder</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">():]</span> <span class="o">=</span> <span class="n">vorder</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">vfcolor</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;vertex_fill_color&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">vcolor</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;vertex_color&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">vertex_color</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
    <span class="n">vertex_border_color</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vfcolor</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="n">vertex_color</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">vfcolor</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">vcolor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vertex_color</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">vfcolor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vertex_color</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcmap</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">B</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vcolor</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
            <span class="n">vertex_border_color</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcolor</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">vcolor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vertex_border_color</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcolor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vertex_border_color</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">colorConverter</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="s">&quot;#babdb6&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">():</span>
            <span class="n">vertex_color</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span>  <span class="n">colorConverter</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="s">&quot;#a40000&quot;</span><span class="p">,</span> <span class="n">halpha</span><span class="p">)</span>
            <span class="n">vertex_border_color</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">colorConverter</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="s">&quot;#babdb6&quot;</span><span class="p">,</span> <span class="n">halpha</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">overlap</span><span class="p">:</span>
        <span class="n">vshape</span><span class="o">.</span><span class="n">a</span><span class="p">[:</span><span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">14</span>
        <span class="n">vertex_pie_frac</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;vector&lt;int&gt;&quot;</span><span class="p">)</span>
        <span class="n">vertex_pie_colors</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;vector&lt;double&gt;&quot;</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="n">vertex_pie_frac</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="n">clrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">vcmap</span><span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">B</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">bv</span><span class="p">[</span><span class="n">v</span><span class="p">]]</span>
            <span class="n">vertex_pie_colors</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">clrs</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vertex_pie_frac</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vertex_pie_colors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>


    <span class="n">tangle</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">vertices</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">():</span>
            <span class="k">break</span>
        <span class="n">tangle</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;drawing...&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_cts</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">picked</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vprops</span><span class="p">,</span> <span class="n">eprops</span><span class="p">):</span>
        <span class="n">vmask</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">vertex_index</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s">&quot;int&quot;</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">GraphView</span><span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">directed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">vfilt</span><span class="o">=</span><span class="n">vmask</span><span class="o">.</span><span class="n">fa</span> <span class="o">&lt;</span> <span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">())</span>
        <span class="n">cts</span> <span class="o">=</span> <span class="n">eprops</span><span class="p">[</span><span class="s">&quot;control_points&quot;</span><span class="p">]</span>
        <span class="n">get_hierarchy_control_points</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">t_orig</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">cts</span><span class="o">=</span><span class="n">cts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_branch</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">key_id</span><span class="p">,</span> <span class="n">picked</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vprops</span><span class="p">,</span> <span class="n">eprops</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key_id</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">picked</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">picked</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">picked</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">g</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">():</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">shortest_path</span><span class="p">(</span><span class="n">t_orig</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">t_orig</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">t_orig</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                  <span class="n">target</span><span class="o">=</span><span class="n">picked</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">bstack</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get_bstack</span><span class="p">()</span>
                <span class="n">bs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&quot;b&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">a</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">bstack</span><span class="p">[:</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">bs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">overlap</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">project_level</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">b</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">GraphView</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">vfilt</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="n">tb</span><span class="p">[</span><span class="n">picked</span><span class="p">])</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&quot;b&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">b</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">prune</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">vp</span><span class="p">[</span><span class="s">&quot;b&quot;</span><span class="p">]</span>
                    <span class="n">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">a</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">be</span> <span class="o">=</span> <span class="n">orig_state</span><span class="o">.</span><span class="n">project_level</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">get_edge_blocks</span><span class="p">()</span>
                    <span class="n">emask</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s">&quot;bool&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
                        <span class="n">rs</span> <span class="o">=</span> <span class="n">be</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tb</span><span class="p">[</span><span class="n">picked</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">tb</span><span class="p">[</span><span class="n">picked</span><span class="p">]:</span>
                            <span class="n">emask</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">GraphView</span><span class="p">(</span><span class="n">GraphView</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">efilt</span><span class="o">=</span><span class="n">emask</span><span class="p">),</span>
                                  <span class="n">vfilt</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="n">out_degree</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="s">&quot;be&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_state</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_edge_blocks</span><span class="p">()</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">prune</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">be</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">ep</span><span class="p">[</span><span class="s">&quot;be&quot;</span><span class="p">]</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">OverlapBlockState</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">be</span><span class="p">)</span>
                    <span class="n">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">nstate</span> <span class="o">=</span> <span class="n">NestedBlockState</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                                          <span class="n">overlap</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">overlap</span><span class="p">,</span>
                                          <span class="n">deg_corr</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">deg_corr</span><span class="p">)</span>

                <span class="n">draw_hierarchy</span><span class="p">(</span><span class="n">nstate</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">ealpha</span><span class="o">=</span><span class="n">ealpha</span><span class="p">,</span> <span class="n">halpha</span><span class="o">=</span><span class="n">halpha</span><span class="p">,</span>
                               <span class="n">subsample_edges</span><span class="o">=</span><span class="n">subsample_edges</span><span class="p">,</span>
                               <span class="n">deg_order</span><span class="o">=</span><span class="n">deg_order</span><span class="p">,</span> <span class="n">deg_size</span><span class="o">=</span><span class="n">deg_size</span><span class="p">,</span>
                               <span class="n">vsize_scale</span><span class="o">=</span><span class="n">vsize_scale</span><span class="p">,</span> <span class="n">hsize_scale</span><span class="o">=</span><span class="n">hsize_scale</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">empty_branches</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">no_main</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_id</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;r&#39;</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ungroup_vector_property</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">x</span><span class="o">.</span><span class="n">a</span> <span class="o">-=</span> <span class="n">x</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">y</span><span class="o">.</span><span class="n">a</span> <span class="o">-=</span> <span class="n">y</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">gg</span><span class="o">.</span><span class="n">new_vertex_property</span><span class="p">(</span><span class="s">&quot;double&quot;</span><span class="p">)</span>
            <span class="n">angle</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">tpos</span> <span class="o">=</span> <span class="n">radial_tree_layout</span><span class="p">(</span><span class="n">t_orig</span><span class="p">,</span>
                                      <span class="n">root</span><span class="o">=</span><span class="n">t_orig</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">t_orig</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                      <span class="n">rel_order</span><span class="o">=</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">gg</span><span class="o">.</span><span class="n">copy_property</span><span class="p">(</span><span class="n">tpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
            <span class="n">update_cts</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">gg</span><span class="p">,</span> <span class="n">picked</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vprops</span><span class="p">,</span> <span class="n">eprops</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">vertex_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">vertex_matrix</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">picked</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">selected</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">queue_draw</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;edge_color&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">egradient</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;edge_color&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;edge_gradient&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;edge_gradient&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;edge_pen_width&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;edge_pen_width&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;edge_text&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;edge_text&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;vertex_color&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;vertex_color&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;vertex_fill_color&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;vertex_fill_color&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;vertex_text&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s">&quot;vertex_text&quot;</span><span class="p">]</span>


    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
                  <span class="n">vorder</span><span class="o">=</span><span class="n">vorder</span><span class="p">,</span>
                  <span class="n">vertex_size</span><span class="o">=</span><span class="n">vsize</span><span class="p">,</span>
                  <span class="n">vertex_fill_color</span><span class="o">=</span><span class="n">vertex_color</span><span class="p">,</span>
                  <span class="n">vertex_color</span><span class="o">=</span><span class="n">vertex_border_color</span><span class="p">,</span>
                  <span class="c">#vertex_pen_width = 2,</span>
                  <span class="c">#vertex_text_rotation=tangle,</span>
                  <span class="n">edge_control_points</span><span class="o">=</span><span class="n">cts</span><span class="p">,</span>
                  <span class="n">edge_gradient</span><span class="o">=</span><span class="n">egradient</span><span class="p">,</span>
                  <span class="n">edge_pen_width</span><span class="o">=</span><span class="n">epw</span><span class="p">,</span>
                  <span class="n">vertex_shape</span><span class="o">=</span><span class="n">vshape</span><span class="p">,</span>
                  <span class="n">vertex_text</span><span class="o">=</span><span class="n">vertex_text</span><span class="p">,</span>
                  <span class="n">vertex_pie_fractions</span><span class="o">=</span><span class="n">vertex_pie_frac</span><span class="p">,</span>
                  <span class="n">vertex_pie_colors</span><span class="o">=</span><span class="n">vertex_pie_colors</span><span class="p">,</span>
                  <span class="n">edge_color</span><span class="o">=</span><span class="n">ecolor</span><span class="p">,</span>
                  <span class="n">edge_end_marker</span><span class="o">=</span><span class="n">em</span><span class="p">,</span>
                  <span class="n">edge_marker_size</span><span class="o">=</span><span class="n">ems</span><span class="p">,</span>
                  <span class="n">edge_text</span><span class="o">=</span><span class="n">elabels</span><span class="p">,</span>
                  <span class="n">layout_callback</span><span class="o">=</span><span class="n">update_cts</span><span class="p">,</span>
                  <span class="n">key_press_callback</span><span class="o">=</span><span class="n">draw_branch</span><span class="p">,</span>
                  <span class="n">display_props</span><span class="o">=</span><span class="p">[</span><span class="n">tb</span><span class="p">])</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">))</span>

    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">graph_draw</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">PropertyMap</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">own_property</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">own_property</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
               <span class="n">g</span><span class="o">.</span><span class="n">own_property</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">tpos</span>

<span class="c"># Bottom imports to avoid circular dependency issues</span></div>
<span class="kn">from</span> <span class="nn">..</span> <span class="nn">community</span> <span class="kn">import</span> <span class="n">get_hierarchy_tree</span><span class="p">,</span> <span class="n">NestedBlockState</span><span class="p">,</span> <span class="n">BlockState</span><span class="p">,</span> <span class="n">OverlapBlockState</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<!-- <a href="graph-tool.pdf">(Download PDF version)</a> -->

<p/>
Latest <a href="/doc/dev/">development version docs</a> are also available.

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><img src="../../../_static/graph-icon.png" alt="logo" style="margin-right: 5px; margin-bottom:-2px;" /><a href="/">Project Homepage</a> &raquo;</li>
    
        <li class="nav-item nav-item-0"><a href="../../../index.html">graph-tool 2.2.44 documentation</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../graph_tool.html" >graph_tool</a> &raquo;</li>
          <li class="nav-item nav-item-3"><a href="../draw.html" >graph_tool.draw</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Tiago de Paula Peixoto &lt;tiago@skewed.de&gt;.
      Last updated on Jul 02, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>